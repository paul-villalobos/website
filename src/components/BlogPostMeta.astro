---
import type { ProcessedPost, PostMeta, BreadcrumbItem } from '../utils/blogUtils';
import { 
  generatePostMeta, 
  generatePostStructuredData, 
  generateBreadcrumbs,
  generateBreadcrumbStructuredData 
} from '../utils/blogUtils';

export interface Props {
  post: ProcessedPost;
  includeBreadcrumbs?: boolean;
  includeRelatedPosts?: boolean;
}

const { post, includeBreadcrumbs = true, includeRelatedPosts = false } = Astro.props;

// Generar metadatos específicos del post
const postMeta: PostMeta = generatePostMeta(post);
const postStructuredData = generatePostStructuredData(post);
const breadcrumbs: BreadcrumbItem[] = includeBreadcrumbs ? generateBreadcrumbs(post) : [];
const breadcrumbStructuredData = includeBreadcrumbs ? generateBreadcrumbStructuredData(breadcrumbs) : null;

// Combinar datos estructurados
const combinedStructuredData = {
  "@context": "https://schema.org",
  "@graph": [
    postStructuredData,
    ...(breadcrumbStructuredData ? [breadcrumbStructuredData] : [])
  ]
};
---

<!-- Metadatos específicos del post -->
<Fragment slot="head">
  <!-- Meta tags específicos del post -->
  <title>{postMeta.title}</title>
  <meta name="description" content={postMeta.description} />
  <meta name="keywords" content={postMeta.keywords} />
  <meta name="author" content={postMeta.author} />
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
  
  <!-- Canonical URL específica del post -->
  <link rel="canonical" href={postMeta.canonical} />
  
  <!-- Open Graph específico del post -->
  <meta property="og:type" content={postMeta.ogType} />
  <meta property="og:url" content={postMeta.canonical} />
  <meta property="og:title" content={postMeta.title} />
  <meta property="og:description" content={postMeta.description} />
  <meta property="og:image" content={postMeta.ogImage} />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:alt" content={post.data.title} />
  <meta property="og:site_name" content="Paul Villalobos" />
  <meta property="og:locale" content="es_ES" />
  <meta property="article:published_time" content={post.data.pubDate} />
  <meta property="article:modified_time" content={post.data.updatedDate || post.data.pubDate} />
  <meta property="article:author" content={postMeta.author} />
  <meta property="article:section" content={post.data.category || "General"} />
  {post.data.tags?.map((tag: string) => (
    <meta property="article:tag" content={tag} />
  ))}
  
  <!-- Twitter específico del post -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content={postMeta.canonical} />
  <meta name="twitter:title" content={postMeta.title} />
  <meta name="twitter:description" content={postMeta.description} />
  <meta name="twitter:image" content={postMeta.ogImage} />
  <meta name="twitter:creator" content="@paulvillalobos" />
  
  <!-- Additional SEO Meta Tags -->
  <meta name="theme-color" content="#0B5FFF" />
  <meta name="msapplication-TileColor" content="#0B5FFF" />
  
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(combinedStructuredData)}></script>
  
  <!-- Meta tags adicionales para el post -->
  <meta name="post:reading-time" content={postMeta.readingTime} />
  <meta name="post:word-count" content={post.data.body?.split(' ').length || 0} />
  <meta name="post:category" content={post.data.category || ""} />
  <meta name="post:tags" content={post.data.tags?.join(', ') || ""} />
</Fragment>

<!-- Breadcrumbs visuales -->
{includeBreadcrumbs && breadcrumbs.length > 0 && (
  <nav class="mb-4" aria-label="Breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
    <ol class="flex items-center space-x-2 text-sm text-gray-500">
      {breadcrumbs.map((item, index) => (
        <li class="flex items-center" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <meta itemprop="position" content={(index + 1).toString()} />
          {index > 0 && (
            <svg class="w-4 h-4 mx-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
          )}
          {index === breadcrumbs.length - 1 ? (
            <span class="text-gray-900" itemprop="name">{item.name}</span>
          ) : (
            <a href={item.url} class="hover:text-gray-700" itemprop="item">
              <span itemprop="name">{item.name}</span>
            </a>
          )}
        </li>
      ))}
    </ol>
  </nav>
)}

<!-- Metadatos del post -->
<div class="flex flex-wrap items-center gap-4 text-sm text-gray-500 mb-6">
  <!-- Fecha de publicación -->
  <div class="flex items-center">
    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
    </svg>
    <time datetime={post.data.pubDate}>{postMeta.publishDate}</time>
  </div>
  
  <!-- Tiempo de lectura -->
  <div class="flex items-center">
    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    {postMeta.readingTime}
  </div>
  
  <!-- Autor -->
  <div class="flex items-center">
    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
    </svg>
    {postMeta.author}
  </div>
  
  <!-- Categoría -->
  {post.data.category && (
    <div class="flex items-center">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
      </svg>
      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
        {post.data.category}
      </span>
    </div>
  )}
</div>

<!-- Tags -->
{post.data.tags && post.data.tags.length > 0 && (
  <div class="flex flex-wrap gap-2 mb-6">
    {post.data.tags.map((tag: string) => (
      <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-slate-100 text-slate-700">
        {tag}
      </span>
    ))}
  </div>
)}
