---
import { getCollection } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';
import BlogCard from '../../components/BlogCard.astro';
import FilterDropdown from '../../components/FilterDropdown.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import { 
  calculateCounts, 
  processPostData, 
  sortPostsByDate, 
  generateBlogStructuredData,
  generateBlogBreadcrumbs,
  generateBreadcrumbStructuredData,
  combineStructuredData
} from '../../utils/blogUtils';
import { SITE_URL, SITE_TITLE, SITE_DESCRIPTION, DEFAULT_KEYWORDS, AUTHOR_NAME, DEFAULT_OG_IMAGE, BLOG_CATEGORIES } from '../../utils/constants';

// Obtener todos los posts del blog
const allPosts = await getCollection('blog');

// Ordenar por fecha de publicación (más recientes primero)
const sortedPosts = sortPostsByDate(allPosts);

// Calcular contadores para filtros
const { categoryCounts, tagCounts, allCategories, allTags } = calculateCounts(sortedPosts);

// Procesar datos de posts para optimizar el template
const processedPosts = sortedPosts.map(processPostData);

// Generar metadatos SEO
const blogMeta = {
  title: "Blog | Paul Villalobos - Inteligencia Artificial Aplicada a Ventas",
  description: "Artículos sobre inteligencia artificial aplicada a ventas B2B, automatización comercial, estrategias de ventas y transformación digital empresarial.",
  keywords: "blog inteligencia artificial, IA ventas B2B, automatización comercial, estrategias ventas, Paul Villalobos blog, artículos IA, consultoría ventas",
  canonical: `${SITE_URL}/blog`,
  ogImage: DEFAULT_OG_IMAGE,
  ogType: "website",
};

const blogStructuredData = generateBlogStructuredData(processedPosts);

// Generar breadcrumbs para el blog
const blogBreadcrumbs = generateBlogBreadcrumbs();
const blogBreadcrumbStructuredData = generateBreadcrumbStructuredData(blogBreadcrumbs);

// Combinar datos estructurados del blog con breadcrumbs
const combinedBlogStructuredData = combineStructuredData(
  blogStructuredData,
  blogBreadcrumbStructuredData
);
---

<MainLayout
  title={blogMeta.title}
  description={blogMeta.description}
  keywords={blogMeta.keywords}
  canonical={blogMeta.canonical}
  ogImage={blogMeta.ogImage}
  ogType={blogMeta.ogType}
  structuredData={combinedBlogStructuredData}
>
  <main class="min-h-screen bg-white">
    <!-- Hero Section del Blog -->
    <section class="bg-gradient-to-br from-blue-50 to-indigo-100 py-16 lg:py-24">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Breadcrumbs -->
        <Breadcrumb items={blogBreadcrumbs} align="center" />
        
        <div class="text-center max-w-3xl mx-auto">
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-slate-900 leading-tight mb-6">
            Blog
          </h1>
          <p class="text-lg md:text-xl text-slate-600 leading-relaxed mb-8">
            Insights sobre inteligencia artificial aplicada a ventas B2B, automatización comercial y estrategias para maximizar resultados comerciales.
          </p>
          
          <!-- Filtros básicos -->
          <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
            <!-- Filtro por categoría -->
            <FilterDropdown 
              id="category-filter"
              ariaLabel="Filtrar por categoría"
              options={allCategories.map(cat => ({
                value: cat,
                label: BLOG_CATEGORIES[cat] || cat,
                count: categoryCounts[cat]
              }))}
              placeholder="Todas las categorías"
              totalCount={processedPosts.length}
            />
            
            <!-- Filtro por tags -->
            <FilterDropdown 
              id="tags-filter"
              ariaLabel="Filtrar por tags"
              options={allTags.map(tag => ({
                value: tag,
                label: tag,
                count: tagCounts[tag]
              }))}
              placeholder="Todos los tags"
              totalCount={processedPosts.length}
            />
          </div>
          
          <!-- Contador de resultados -->
          <div class="mt-6">
            <p id="results-count" class="text-slate-600">
              Mostrando {processedPosts.length} artículo{processedPosts.length !== 1 ? 's' : ''}
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Contenido Principal -->
    <section class="py-16 lg:py-24">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Grid de Posts -->
        <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {processedPosts.map((post) => (
            <BlogCard post={post} />
          ))}
        </div>
        
        <!-- Estado vacío -->
        <div id="empty-state" class="hidden text-center py-16">
          <svg class="mx-auto h-12 w-12 text-slate-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.29-1.009-5.824-2.709M15 6.291A7.962 7.962 0 0012 5c-2.34 0-4.29 1.009-5.824 2.709"></path>
          </svg>
          <h3 class="text-lg font-semibold text-slate-900 mb-2">No se encontraron artículos</h3>
          <p class="text-slate-600 mb-6">Intenta ajustar los filtros de categoría o tags.</p>
          <button 
            id="clear-filters"
            class="bg-blue-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
          >
            Limpiar filtros
          </button>
        </div>
      </div>
    </section>
  </main>

  <!-- Script del cliente -->
  <script src="/src/scripts/blog.ts"></script>
</MainLayout>