---
import { getCollection } from 'astro:content';
import MainLayout from '../layouts/MainLayout.astro';
import BlogCard from '../components/BlogCard.astro';
import FilterDropdown from '../components/FilterDropdown.astro';
import EmptyState from '../components/EmptyState.astro';
import { 
  calculateCounts, 
  processPostData, 
  sortPostsByDate, 
  generateBlogMeta, 
  generateBlogStructuredData,
  generateBlogBreadcrumbs,
  generateBreadcrumbStructuredData
} from '../utils/blogUtils';

// Obtener todos los posts del blog
const allPosts = await getCollection('blog');

// Ordenar por fecha de publicación (más recientes primero)
const sortedPosts = sortPostsByDate(allPosts);

// Calcular contadores para filtros
const { categoryCounts, tagCounts, allCategories, allTags } = calculateCounts(sortedPosts);

// Procesar datos de posts para optimizar el template
const processedPosts = sortedPosts.map(processPostData);

// Generar metadatos SEO
const blogMeta = generateBlogMeta(processedPosts);
const blogStructuredData = generateBlogStructuredData(processedPosts);

// Generar breadcrumbs para el blog
const blogBreadcrumbs = generateBlogBreadcrumbs();
const blogBreadcrumbStructuredData = generateBreadcrumbStructuredData(blogBreadcrumbs);

// Combinar datos estructurados del blog con breadcrumbs
const combinedBlogStructuredData = {
  "@context": "https://schema.org",
  "@graph": [
    blogStructuredData,
    blogBreadcrumbStructuredData
  ]
};
---

<MainLayout
  title={blogMeta.title}
  description={blogMeta.description}
  keywords={blogMeta.keywords}
  canonical={blogMeta.canonical}
  ogImage={blogMeta.ogImage}
  ogType={blogMeta.ogType}
  structuredData={combinedBlogStructuredData}
>
  <main class="min-h-screen bg-white">
    <!-- Hero Section del Blog -->
    <section class="bg-gradient-to-br from-blue-50 to-indigo-100 py-16 lg:py-24">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Breadcrumbs -->
        <nav class="mb-6 flex justify-center" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2 text-sm text-slate-600">
            {blogBreadcrumbs.map((item, index) => (
              <li class="flex items-center">
                {index > 0 && (
                  <svg class="w-4 h-4 mx-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                  </svg>
                )}
                {index === blogBreadcrumbs.length - 1 ? (
                  <span class="text-slate-900 font-medium">{item.name}</span>
                ) : (
                  <a href={item.url} class="hover:text-blue-600 transition-colors duration-200">
                    {item.name}
                  </a>
                )}
              </li>
            ))}
          </ol>
        </nav>
        
        <div class="text-center max-w-3xl mx-auto">
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-slate-900 leading-tight mb-6">
            Blog
          </h1>
          <p class="text-lg md:text-xl text-slate-600 leading-relaxed mb-8">
            Insights sobre inteligencia artificial aplicada a ventas B2B, automatización comercial y estrategias para maximizar resultados comerciales.
          </p>
          
          <!-- Filtros básicos -->
          <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
            <!-- Filtro por categoría -->
            <FilterDropdown 
              id="category-filter"
              options={allCategories.map(cat => ({
                value: cat,
                label: cat,
                count: categoryCounts[cat]
              }))}
              placeholder="Todas las categorías"
              totalCount={processedPosts.length}
            />
            
            <!-- Filtro por tags -->
            <FilterDropdown 
              id="tags-filter"
              options={allTags.map(tag => ({
                value: tag,
                label: tag,
                count: tagCounts[tag]
              }))}
              placeholder="Todos los tags"
              totalCount={processedPosts.length}
            />
          </div>
          
          <!-- Contador de resultados -->
          <div class="mt-6">
            <p id="results-count" class="text-slate-600">
              Mostrando {processedPosts.length} artículo{processedPosts.length !== 1 ? 's' : ''}
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Contenido Principal -->
    <section class="py-16 lg:py-24">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Grid de Posts -->
        <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {processedPosts.map((post) => (
            <BlogCard post={post} />
          ))}
        </div>
        
        <!-- Estado vacío -->
        <EmptyState 
          title="No se encontraron artículos"
          description="Intenta ajustar los filtros de categoría o tags."
          buttonText="Limpiar filtros"
          buttonId="clear-filters"
        />
      </div>
    </section>
  </main>

  <!-- Script del cliente -->
  <script src="/src/scripts/blog.ts"></script>
</MainLayout>