---
import { getCollection } from 'astro:content';
import MainLayout from '../layouts/MainLayout.astro';
import BlogCard from '../components/BlogCard.astro';
import FilterDropdown from '../components/FilterDropdown.astro';
import EmptyState from '../components/EmptyState.astro';
import { 
  calculateCounts, 
  processPostData, 
  sortPostsByDate, 
  generateBlogMeta, 
  generateBlogStructuredData 
} from '../utils/blogUtils';

// Obtener todos los posts del blog
const allPosts = await getCollection('blog');

// Ordenar por fecha de publicación (más recientes primero)
const sortedPosts = sortPostsByDate(allPosts);

// Calcular contadores para filtros
const { categoryCounts, tagCounts, allCategories, allTags } = calculateCounts(sortedPosts);

// Procesar datos de posts para optimizar el template
const processedPosts = sortedPosts.map(processPostData);

// Generar metadatos SEO
const blogMeta = generateBlogMeta(processedPosts);
const blogStructuredData = generateBlogStructuredData(processedPosts);
---

<MainLayout>
  <!-- SEO Script para metadatos dinámicos -->
  <script is:inline>
    // Actualizar metadatos específicos del blog
    document.title = "Blog | Paul Villalobos - Inteligencia Artificial Aplicada a Ventas";
    
    // Actualizar meta description
    const metaDescription = document.querySelector('meta[name="description"]');
    if (metaDescription) {
      metaDescription.setAttribute('content', "Artículos sobre inteligencia artificial aplicada a ventas B2B, automatización comercial, estrategias de ventas y transformación digital empresarial.");
    }
    
    // Actualizar canonical URL
    const canonicalLink = document.querySelector('link[rel="canonical"]');
    if (canonicalLink) {
      canonicalLink.setAttribute('href', "https://paulvillalobos.com/blog");
    }
    
    // Actualizar Open Graph
    const ogTitle = document.querySelector('meta[property="og:title"]');
    const ogDescription = document.querySelector('meta[property="og:description"]');
    const ogUrl = document.querySelector('meta[property="og:url"]');
    
    if (ogTitle) ogTitle.setAttribute('content', "Blog | Paul Villalobos - Inteligencia Artificial Aplicada a Ventas");
    if (ogDescription) ogDescription.setAttribute('content', "Artículos sobre inteligencia artificial aplicada a ventas B2B, automatización comercial, estrategias de ventas y transformación digital empresarial.");
    if (ogUrl) ogUrl.setAttribute('content', "https://paulvillalobos.com/blog");
    
    // Actualizar Twitter
    const twitterTitle = document.querySelector('meta[name="twitter:title"]');
    const twitterDescription = document.querySelector('meta[name="twitter:description"]');
    const twitterUrl = document.querySelector('meta[name="twitter:url"]');
    
    if (twitterTitle) twitterTitle.setAttribute('content', "Blog | Paul Villalobos - Inteligencia Artificial Aplicada a Ventas");
    if (twitterDescription) twitterDescription.setAttribute('content', "Artículos sobre inteligencia artificial aplicada a ventas B2B, automatización comercial, estrategias de ventas y transformación digital empresarial.");
    if (twitterUrl) twitterUrl.setAttribute('content', "https://paulvillalobos.com/blog");
    
    // Agregar datos estructurados del blog
    const blogStructuredDataScript = document.createElement('script');
    blogStructuredDataScript.type = 'application/ld+json';
    blogStructuredDataScript.textContent = JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Blog",
      "name": "Blog de Paul Villalobos",
      "description": "Artículos sobre inteligencia artificial aplicada a ventas B2B, automatización comercial, estrategias de ventas y transformación digital empresarial.",
      "url": "https://paulvillalobos.com/blog",
      "author": {
        "@type": "Person",
        "name": "Paul Villalobos",
        "jobTitle": "Especialista en Inteligencia Artificial Aplicada a Ventas",
        "url": "https://paulvillalobos.com"
      },
      "publisher": {
        "@type": "Person",
        "name": "Paul Villalobos",
        "url": "https://paulvillalobos.com"
      },
      "inLanguage": "es-ES"
    });
    document.head.appendChild(blogStructuredDataScript);
  </script>

  <main class="min-h-screen bg-white">
    <!-- Hero Section del Blog -->
    <section class="bg-gradient-to-br from-blue-50 to-indigo-100 py-16 lg:py-24" itemscope itemtype="https://schema.org/Blog">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center max-w-3xl mx-auto">
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-slate-900 leading-tight mb-6" itemprop="name">
            Blog
          </h1>
          <p class="text-lg md:text-xl text-slate-600 leading-relaxed mb-8" itemprop="description">
            Insights sobre inteligencia artificial aplicada a ventas B2B, automatización comercial y estrategias para maximizar resultados comerciales.
          </p>
          
          <!-- Filtros básicos -->
          <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
            <!-- Filtro por categoría -->
            <FilterDropdown 
              id="category-filter"
              options={allCategories.map(cat => ({
                value: cat,
                label: cat,
                count: categoryCounts[cat]
              }))}
              placeholder="Todas las categorías"
              totalCount={processedPosts.length}
            />
            
            <!-- Filtro por tags -->
            <FilterDropdown 
              id="tags-filter"
              options={allTags.map(tag => ({
                value: tag,
                label: tag,
                count: tagCounts[tag]
              }))}
              placeholder="Todos los tags"
              totalCount={processedPosts.length}
            />
          </div>
          
          <!-- Contador de resultados -->
          <div class="mt-6">
            <p id="results-count" class="text-slate-600">
              Mostrando {processedPosts.length} artículo{processedPosts.length !== 1 ? 's' : ''}
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Contenido Principal -->
    <section class="py-16 lg:py-24">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Grid de Posts -->
        <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {processedPosts.map((post) => (
            <BlogCard post={post} />
          ))}
        </div>
        
        <!-- Estado vacío -->
        <EmptyState 
          title="No se encontraron artículos"
          description="Intenta ajustar los filtros de categoría o tags."
          buttonText="Limpiar filtros"
          buttonId="clear-filters"
        />
      </div>
    </section>
  </main>

  <!-- Script del cliente -->
  <script src="/src/scripts/blog.ts"></script>
</MainLayout>